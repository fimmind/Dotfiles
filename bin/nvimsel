#! /usr/bin/env bash

print_description() {
  echo "
description:
  This script allows you to edit/write X selections (e.g. clipboard)
  using neovim. It opens temporal file, optionally containing current
  text from the specified selection, in neovim and then, after the
  editor is closed, if the file is not empty, it writes text from
  that file to the X selection"
}

print_usage() {
  echo "
usage:
  $(basename "$0") [action [selection]] [--help]

options:
  action        action performed on selection. Options are \"edit\"
                for opening neovim with current text of selection or
                \"write\" for opening nvim with empty file.
                Defaults to \"edit\"

  selection     X selection to use. For more details see xclip's
                manual page (-selection option).
                Defaults to \"clipboard\"

  --help        Forces printing help message with description
"
}

exit_usage() {
  echo "Wrong arguments!"
  print_usage >&2
  exit 2
}

for arg in $@; do
  if [ "$arg" = "--help" ]; then
    print_description
    print_usage
    exit 0
  fi
done

if [ $# -gt 2 ]; then
  exit_usage
fi

action=${1:-edit}
sel=${2:-clipboard}

file=$(mktemp --suffix=.txt)

case $action in
  edit) xclip -selection $sel -o > $file ;;
  write) ;;
  *) rm $file; exit_usage ;;
esac

kitty --class=float -- nvim $file

if [ -s $file ]; then
  xclip -rmlastnl -selection $sel $file
fi

rm $file
